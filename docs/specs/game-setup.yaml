id: game-setup
title: Game Setup and Lineup Management
actor: scorekeeper
goal: create new games and configure starting lineups
outcome: ready-to-play game with proper team selection and batting order

inputs:
  - name: game_name
    type: text
    required: true
    validation: min-length-2
    default: auto-generated
    component_hint: "Input(placeholder='Auto-generated from season and date', data-testid='game-name-input')"
    auto_update: true # updates when season or game_type changes, unless manually modified
  - name: opponent_name
    type: text
    required: true
    validation: min-length-2
  - name: game_date
    type: date
    required: true
    validation: not-past-date
    default: today
    component_hint: "DateInput(defaultValue={new Date().toISOString().split('T')[0]}, data-testid='game-date-input')"
  - name: season_id
    type: select
    required: false
    source: seasons
    default: most_recent_or_first
    component_hint: "Select(placeholder='Choose season', data-testid='season-select')"
  - name: game_type_id
    type: select
    required: false
    source: game_types
    default: most_recent_or_first
    component_hint: "Select(placeholder='Choose game type', data-testid='game-type-select')"
  - name: team_id
    type: select
    required: true
    source: teams
    default: most_recent_or_first
    component_hint: "Select(placeholder='Choose team', data-testid='team-select')"
  - name: home_away
    type: radio
    required: true
    options: [home, away]
    default: home
  - name: starting_positions_count
    type: number
    required: false
    validation: range-9-12
    default: 10
    component_hint: "NumberInput(min={9}, max={12}, defaultValue={10}, data-testid='starting-positions-count')"
  - name: starting_lineup
    type: array
    required: true
    validation: min-length-9
  - name: substitutes
    type: array
    required: false
  - name: batting_position
    type: number
    required: true
    validation: range-1-15
  - name: defensive_position
    type: select
    required: true
    options:
      [
        pitcher,
        catcher,
        first-base,
        second-base,
        third-base,
        shortstop,
        left-field,
        center-field,
        right-field,
        short-fielder,
        extra-player,
      ]
    display_format: 'position_name (abbreviation)' # e.g., "Pitcher (P)"
    smart_ordering: player_positions_first # show player's available positions first

actions:
  - type: create
    label: Create Game
    target: game
  - type: select
    label: Select Team
    target: team
  - type: configure
    label: Set Lineup
    target: lineup
  - type: add
    label: Add to Lineup
    target: player
  - type: remove
    label: Remove from Lineup
    target: player
  - type: reorder
    label: Reorder Batting Order
    target: lineup
  - type: assign
    label: Assign Position
    target: player

entities:
  game:
    properties:
      - id: uuid
      - name: string
      - opponent: string
      - date: datetime
      - season_id: uuid | null
      - game_type_id: uuid | null
      - home_away: enum
      - team_id: uuid
      - status: enum [setup, in_progress, completed]
      - created_at: datetime
  lineup:
    properties:
      - id: uuid
      - game_id: uuid
      - batting_order: array<lineup_position>
      - substitutes: array<player_id>
  lineup_position:
    properties:
      - batting_order: number
      - player_id: uuid
      - defensive_position: string
      - is_starting: boolean

acceptance_criteria:
  - id: AC001
    description: games can be created with essential metadata (name, opponent, date, team)
    workflow: game_creation
  - id: AC002
    description: new games are saved with status "setup"
    workflow: game_creation
  - id: AC003
    description: created games appear in the games interface
    workflow: game_creation
  - id: AC004
    description: date input displays today's date by default when form opens
    workflow: game_creation
  - id: AC005
    description: form can be submitted without changing the default date
    workflow: game_creation
  - id: AC006
    description: date input allows changing to any valid future or past date
    workflow: game_creation
  - id: AC007
    description: setup lineup button appears on game cards after creation
    workflow: lineup_management
  - id: AC008
    description: lineup management modal opens when setup lineup is clicked
    workflow: lineup_management
  - id: AC009
    description: all team players are available for selection in lineup modal
    workflow: lineup_management
  - id: AC010
    description: batting order can be set (1-9 positions minimum)
    workflow: lineup_management
  - id: AC011
    description: defensive positions can be assigned to each player
    workflow: lineup_management
  - id: AC012
    description: start game button is disabled until lineup is complete
    workflow: game_creation
  - id: AC013
    description: lineup marked incomplete with fewer than 9 batting positions
    workflow: lineup_management
  - id: AC014
    description: lineup marked incomplete without all defensive positions assigned
    workflow: lineup_management
  - id: AC015
    description: start game button enabled with complete valid lineup
    workflow: game_creation
  - id: AC016
    description: clicking start game changes status to in_progress
    workflow: game_creation
  - id: AC017
    description: clicking start game redirects to scoring interface
    workflow: game_creation
  - id: AC018
    description: setup lineup button changes to view/edit lineup after game starts
    workflow: game_creation
  - id: AC019
    description: lineup changes are saved automatically
    workflow: lineup_management
  - id: AC020
    description: lineup progress preserved when modal closed without completing
    workflow: lineup_management
  - id: AC021
    description: game lineupId populated after lineup setup completion
    workflow: lineup_management

validation_rules:
  - minimum starting players equals configured count (9-12, default 10)
  - maximum 15 players total per game
  - batting order numbers must be unique and sequential
  - final lineup must have unique defensive positions (11 positions total)
  - duplicate positions allowed during setup for user resolution
  - game date cannot be in the past
  - opponent name cannot be same as team name
  - game name auto-generation preserves manual modifications

business_rules:
  - game name auto-generates as "[Season Name] - [Date]" format
  - game name auto-updates when season/game type changes, unless manually modified
  - form fields remember most recent selections (team, season, game type)
  - starting lineup count configurable 9-12 in UI, default 10
  - defensive positions: P, C, 1B, 2B, 3B, SS, LF, CF, RF, SF, EP (11 total positions)
  - players auto-assigned their first (default) position when added to lineup
  - position dropdowns show player's available positions first, then other positions
  - duplicate positions allowed during setup, resolved by user
  - batting order starts at position 1
  - game setup must be completed before scoring can begin

workflows:
  game_creation:
    steps:
      - select_team
      - enter_game_details
      - configure_lineup
      - assign_positions
      - confirm_setup
  lineup_management:
    steps:
      - select_starting_players
      - set_batting_order
      - assign_defensive_positions
      - add_substitutes
      - validate_lineup

error_states:
  - name: IncompleteLineup
    http_status: 400
    response_body:
      error_code: 'LINEUP_INCOMPLETE'
      message: 'Lineup must have at least 9 batting positions and all defensive positions assigned'
  - name: InvalidBattingOrder
    http_status: 400
    response_body:
      error_code: 'BATTING_ORDER_INVALID'
      message: 'Batting order must be sequential starting from 1'
  - name: DuplicatePosition
    http_status: 400
    response_body:
      error_code: 'POSITION_DUPLICATE'
      message: 'Each defensive position can only be assigned to one player'
  - name: PlayerNotOnTeam
    http_status: 400
    response_body:
      error_code: 'PLAYER_NOT_ON_TEAM'
      message: 'Selected player is not on the chosen team'
  - name: NoPlayersAvailable
    http_status: 400
    response_body:
      error_code: 'NO_PLAYERS_AVAILABLE'
      message: 'Selected team has no active players available for lineup'

defensive_actions:
  retry_policy: 'manual-user-correction (no automatic retry for user input errors)'
  validation: 'real-time validation as user makes lineup changes'
  fallback: 'preserve partial lineup progress if modal is closed accidentally'
  error_recovery: 'highlight specific lineup issues and guide user to resolution'

component_hints:
  setup_lineup_button: "Button(leftIcon=<EditIcon />, colorScheme='blue', variant='outline', data-testid='setup-lineup-button')"
  lineup_modal: "Modal(isOpen={isOpen}, onClose={onClose}, size='xl', data-testid='lineup-setup-modal')"
  batting_order_input: "NumberInput(min={1}, max={15}, data-testid='batting-order-input')"
  position_select: "Select(placeholder='Select Position', data-testid='defensive-position-select')"
  player_select: "Select(placeholder='Select Player', data-testid='player-select')"
  start_game_button: "Button(colorScheme='green', isDisabled={!lineupComplete}, data-testid='start-game-button')"

traceability:
  source_story_id: 'game-setup'
  acceptance_criteria_covered:
    [
      'AC001',
      'AC002',
      'AC003',
      'AC004',
      'AC005',
      'AC006',
      'AC007',
      'AC008',
      'AC009',
      'AC010',
      'AC011',
      'AC012',
      'AC013',
      'AC014',
      'AC015',
      'AC016',
      'AC017',
      'AC018',
      'AC019',
      'AC020',
      'AC021',
    ]
  test_files:
    [
      'tests/unit/presentation/pages/GamePage.test.tsx',
      'tests/unit/presentation/components/LineupSetupModal.test.tsx',
      'tests/e2e/game-creation-basic.spec.ts',
      'tests/e2e/game-setup-lineup.spec.ts',
    ]

meta:
  status: active
  version: 3.0.0
  priority: high
  dependencies: [team-management]
  created_by: breaking-bat-team
  design_spec_url: 'lineup-setup-modal-wireframe.md'
  created_date: '2025-01-15'
  last_updated: '2025-01-15'
